# code: language=ansible
---
- name: Install prerequisites
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - apt-transport-https
      - unbound
    state: present

- name: Add Tor's official GPG key
  ansible.builtin.apt_key:
    url: 'https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc'
    keyring: /usr/share/keyrings/tor-archive-keyring.gpg
    state: present
# yamllint disable rule:line-length
- name: Add Tor's official apt repository
  ansible.builtin.apt_repository:
    update_cache: true
    filename: tor

    repo: 'deb [arch=amd64 signed-by=/usr/share/keyrings/tor-archive-keyring.gpg] https://deb.torproject.org/torproject.org {{ ansible_distribution_release }} main'
    state: present

- name: Add Tor's official apt source repository
  ansible.builtin.apt_repository:
    update_cache: true
    filename: tor
    repo: 'deb-src [arch=amd64 signed-by=/usr/share/keyrings/tor-archive-keyring.gpg] https://deb.torproject.org/torproject.org {{ ansible_distribution_release }} main'
    state: present
# yamllint enable rule:line-length

- name: Install tor, nyx, and debian keyring
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - tor
      - deb.torproject.org-keyring
    state: present

- name: Copy Tor Exit Notice Page
  ansible.builtin.copy:
    src: tor-exit-notice.html
    dest: /etc/tor/tor-exit-notice.html
    owner: debian-tor
    group: debian-tor
    mode: '0644'

- name: Create Directories for Tor Exit Node 1 and 2
  ansible.builtin.file:
    path: '/etc/tor/{{ item }}'
    state: directory
    owner: debian-tor
    group: debian-tor
    mode: '0644'
  loop:
    - /node1
    - /node2

- name: Create Log Files for Tor Exit Node 1 and 2
  ansible.builtin.file:
    path: '/etc/tor/{{ item }}'
    state: touch
    owner: debian-tor
    group: debian-tor
    mode: '0644'
    modification_time: preserve
    access_time: preserve
  loop:
    - /node1/notices.log
    - /node2/notices.log

- name: Load Encrypted Variables for Populating Torrc Files
  ansible.builtin.include_vars:
    file: secrets.yml.vault

- name: Configure Tor Node 1
  ansible.builtin.template:
    src: torrc.j2
    dest: /etc/tor/node1/torrc
    owner: debian-tor
    group: debian-tor
    mode: '0644'
  vars:
    relay_nickname: '{{ tor_relay_nickname }}'
    relay_contact_info: '{{ tor_relay_contact_info }}'
    relay_ipv4_address: '{{ tor_relay_ipv4_address }}'
    relay_ipv6_address: '{{ tor_relay_ipv6_address }}'
    relay_family_members: '{{ tor_relay_family_members }}'
    relay_oport: '{{ tor_relay_oport }}'
    relay_oport_node2: '{{ tor_relay_oport_node2 }}'

- name: Copy unbound Config
  ansible.builtin.copy:
    src: unbound.tor.conf
    dest: /etc/unbound/unbound.conf.d/tor.conf
    owner: root
    group: root
    mode: '0644'

- name: Create unbound Log Directory
  ansible.builtin.file:
    path: /etc/unbound/logs
    state: directory
    owner: unbound
    group: unbound
    mode: '0755'

- name: Create unbound Log File
  ansible.builtin.file:
    path: /etc/unbound/logs/unbound.log
    state: touch
    owner: unbound
    group: unbound
    mode: '0644'
    modification_time: preserve
    access_time: preserve
